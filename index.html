<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="description" content="毎日の体調管理アプリ" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" />
    <title>HealthFlow</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for compiling React in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
        overscroll-behavior-y: none;
      }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      
      #error-container {
        display: none;
        padding: 20px;
        background: #fee2e2;
        color: #991b1b;
        margin: 20px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        font-size: 14px;
        z-index: 9999;
        position: relative;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      #loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #4f46e5;
        font-weight: bold;
        flex-direction: column;
        gap: 1rem;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e0e7ff;
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>

    <!-- Import Map: Fixed to use compatible versions only -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
    "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "date-fns/": "https://esm.sh/date-fns@^4.1.0/"
  }
}
</script>
  </head>
  <body>
    <!-- Global Error Handler -->
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('loading').style.display = 'none';
        const errorContainer = document.getElementById('error-container');
        errorContainer.style.display = 'block';
        const msg = typeof message === 'string' ? message : JSON.stringify(message);
        errorContainer.textContent = 'エラーが発生しました:\n' + msg + '\n\n場所: ' + source + ':' + lineno;
        console.error('Global Error:', error);
      };
      
      window.addEventListener('unhandledrejection', function(event) {
        document.getElementById('loading').style.display = 'none';
        const errorContainer = document.getElementById('error-container');
        errorContainer.style.display = 'block';
        errorContainer.textContent = '通信エラーまたは予期せぬエラー:\n' + event.reason;
        console.error('Unhandled Rejection:', event.reason);
      });
    </script>

    <div id="loading">
      <div class="spinner"></div>
      <div>アプリを読み込み中...</div>
    </div>
    <div id="error-container"></div>
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState, useEffect, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Calendar, BarChart2, Activity, X, Save, Trash2, Wheat, Brain, 
        ChevronLeft, ChevronRight 
      } from 'lucide-react';
      import { 
        format, startOfMonth, endOfMonth, eachDayOfInterval, startOfWeek, 
        endOfWeek, addMonths, subMonths, isSameMonth, isToday, subDays 
      } from 'date-fns';
      import { ja } from 'date-fns/locale';
      import { 
        ResponsiveContainer, ComposedChart, Line, Bar, XAxis, YAxis, 
        CartesianGrid, Tooltip, ReferenceLine, Legend 
      } from 'recharts';

      // --- CONSTANTS ---
      
      const SCORE_COLORS = {
        5: 'bg-emerald-400',
        4: 'bg-teal-300',
        3: 'bg-yellow-300',
        2: 'bg-orange-300',
        1: 'bg-rose-400',
      };

      const MENTAL_COLORS = {
        5: 'bg-sky-400',
        4: 'bg-blue-300',
        3: 'bg-indigo-300',
        2: 'bg-violet-300',
        1: 'bg-purple-400',
      };

      const SCORE_LABELS = {
        5: '最高 (Excellent)',
        4: '良い (Good)',
        3: '普通 (Average)',
        2: '不調 (Poor)',
        1: '最悪 (Terrible)',
      };

      const CHART_COLORS = {
        physical: '#10b981', // Emerald-500
        mental: '#3b82f6',   // Blue-500
        wheat: '#fcd34d',    // Amber-300
      };

      // --- STORAGE SERVICE ---

      const STORAGE_KEY = 'healthflow_logs';

      const getLogs = () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          return stored ? JSON.parse(stored) : {};
        } catch (e) {
          console.error("Failed to load logs", e);
          return {};
        }
      };

      const saveLog = (log) => {
        const logs = getLogs();
        logs[log.date] = log;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      };

      const deleteLog = (date) => {
        const logs = getLogs();
        delete logs[date];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
      };

      // --- COMPONENTS ---

      const Button = ({ 
        children, 
        variant = 'primary', 
        size = 'md', 
        icon, 
        className = '', 
        ...props 
      }) => {
        const baseStyles = "inline-flex items-center justify-center rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
        
        const variants = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 shadow-sm",
          secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 focus:ring-indigo-500 shadow-sm",
          danger: "bg-red-50 text-red-700 border border-transparent hover:bg-red-100 focus:ring-red-500",
          ghost: "bg-transparent text-gray-600 hover:bg-gray-100 focus:ring-gray-500",
        };

        const sizes = {
          sm: "px-3 py-1.5 text-xs",
          md: "px-4 py-2 text-sm",
          lg: "px-6 py-3 text-base",
        };

        return (
          <button 
            className={`${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`}
            {...props}
          >
            {icon && <span className="mr-2">{icon}</span>}
            {children}
          </button>
        );
      };

      const LogModal = ({
        isOpen,
        onClose,
        date,
        existingLog,
        onSave,
        onDelete,
      }) => {
        const [score, setScore] = useState(3);
        const [mentalScore, setMentalScore] = useState(3);
        const [wheatIntake, setWheatIntake] = useState(false);
        const [note, setNote] = useState('');

        useEffect(() => {
          if (isOpen) {
            if (existingLog) {
              setScore(existingLog.score);
              setMentalScore(existingLog.mentalScore ?? 3);
              setWheatIntake(existingLog.wheatIntake ?? false);
              setNote(existingLog.note);
            } else {
              setScore(3);
              setMentalScore(3);
              setWheatIntake(false);
              setNote('');
            }
          }
        }, [isOpen, existingLog, date]);

        if (!isOpen) return null;

        const dateStr = format(date, 'yyyy-MM-dd');
        const formattedDate = format(date, 'yyyy年 M月 d日 (EEEE)', { locale: ja });

        const handleSave = () => {
          onSave({
            date: dateStr,
            score,
            mentalScore,
            wheatIntake,
            note,
          });
          onClose();
        };

        const handleDelete = () => {
          if (confirm('この日の記録を削除しますか？')) {
            onDelete(dateStr);
            onClose();
          }
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform transition-all animate-in fade-in zoom-in-95 duration-200 max-h-[90vh] flex flex-col">
              
              {/* Header */}
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50 flex-shrink-0">
                <h2 className="text-lg font-semibold text-gray-800">{formattedDate}</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                  <X size={20} />
                </button>
              </div>

              {/* Body */}
              <div className="p-6 space-y-6 overflow-y-auto flex-1 custom-scrollbar">
                
                {/* Physical */}
                <div className="space-y-4">
                  <div className="flex items-center gap-2 text-gray-800">
                    <div className="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
                      <Activity size={20} className="opacity-90" />
                    </div>
                    <label className="text-lg font-bold">体調</label>
                  </div>
                  <div className="flex justify-between gap-2">
                    {[1, 2, 3, 4, 5].map((s) => (
                      <button
                        key={s}
                        onClick={() => setScore(s)}
                        className={`flex-1 h-14 rounded-xl border-2 transition-all duration-200 flex flex-col items-center justify-center
                          ${score === s 
                            ? `${SCORE_COLORS[s]} border-transparent text-white shadow-lg scale-105` 
                            : 'border-gray-100 text-gray-400 hover:border-gray-200 bg-white hover:bg-gray-50'
                          }`}
                      >
                        <span className="text-xl font-black leading-none">{s}</span>
                      </button>
                    ))}
                  </div>
                  <div className="text-center font-medium text-sm text-gray-600 bg-gray-50 py-1 rounded-lg">
                    {SCORE_LABELS[score]}
                  </div>
                </div>

                {/* Mental */}
                <div className="bg-slate-50 rounded-xl p-4 border border-slate-100">
                  <div className="flex items-center gap-2 mb-3">
                    <Brain size={16} className="text-slate-500" />
                    <label className="text-sm font-semibold text-slate-600">メンタル</label>
                  </div>
                  <div className="flex justify-between gap-2">
                    {[1, 2, 3, 4, 5].map((s) => (
                      <button
                        key={s}
                        onClick={() => setMentalScore(s)}
                        className={`flex-1 h-9 rounded-lg border transition-all duration-200 flex items-center justify-center text-sm font-bold
                          ${mentalScore === s 
                            ? `${MENTAL_COLORS[s]} border-transparent text-white shadow-sm` 
                            : 'border-slate-200 text-slate-400 hover:border-slate-300 bg-white'
                          }`}
                      >
                        {s}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Wheat */}
                <div className="bg-amber-50 rounded-xl p-4 border border-amber-100">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 text-amber-800">
                      <Wheat size={20} />
                      <span className="font-medium text-sm">小麦製品</span>
                    </div>
                    <button
                      onClick={() => setWheatIntake(!wheatIntake)}
                      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${
                        wheatIntake ? 'bg-amber-500' : 'bg-gray-200'
                      }`}
                    >
                      <span
                        className={`${
                          wheatIntake ? 'translate-x-6' : 'translate-x-1'
                        } inline-block h-4 w-4 transform rounded-full bg-white transition-transform`}
                      />
                    </button>
                  </div>
                  <p className="text-xs text-amber-700/70 mt-1 ml-7">
                    {wheatIntake ? '摂取しました' : '摂取していません'}
                  </p>
                </div>

                {/* Note */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">メモ</label>
                  <textarea
                    value={note}
                    onChange={(e) => setNote(e.target.value)}
                    className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none bg-gray-50/50 transition-all"
                    rows={4}
                    placeholder="今日はどんな一日でしたか？"
                  />
                </div>
              </div>

              {/* Footer */}
              <div className="px-6 py-4 bg-gray-50 border-t border-gray-100 flex items-center justify-between flex-shrink-0">
                {existingLog ? (
                  <Button variant="danger" size="sm" onClick={handleDelete} icon={<Trash2 size={16} />}>
                    削除
                  </Button>
                ) : (
                  <div></div>
                )}
                <div className="flex gap-3">
                  <Button variant="secondary" onClick={onClose}>キャンセル</Button>
                  <Button onClick={handleSave} icon={<Save size={16} />}>保存する</Button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const CalendarView = ({ logs, onDateClick }) => {
        const [currentDate, setCurrentDate] = useState(new Date());

        const firstDayOfMonth = startOfMonth(currentDate);
        const lastDayOfMonth = endOfMonth(currentDate);
        const startDate = startOfWeek(firstDayOfMonth, { weekStartsOn: 0 });
        const endDate = endOfWeek(lastDayOfMonth, { weekStartsOn: 0 });

        const calendarDays = eachDayOfInterval({ start: startDate, end: endDate });
        const weekDayLabels = ['日', '月', '火', '水', '木', '金', '土'];

        const prevMonth = () => setCurrentDate(subMonths(currentDate, 1));
        const nextMonth = () => setCurrentDate(addMonths(currentDate, 1));

        return (
          <div className="flex flex-col h-full bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="flex items-center justify-between px-6 py-5 border-b border-gray-100 bg-white">
              <h2 className="text-xl font-bold text-gray-800 tracking-tight">
                {format(currentDate, 'yyyy年 M月', { locale: ja })}
              </h2>
              <div className="flex space-x-1">
                <button onClick={prevMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
                  <ChevronLeft size={20} />
                </button>
                <button onClick={nextMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600">
                  <ChevronRight size={20} />
                </button>
              </div>
            </div>

            <div className="grid grid-cols-7 border-b border-gray-100 bg-gray-50/50">
              {weekDayLabels.map((day, i) => (
                <div key={day} className={`py-3 text-center text-xs font-semibold ${i === 0 ? 'text-rose-500' : i === 6 ? 'text-blue-500' : 'text-gray-500'}`}>
                  {day}
                </div>
              ))}
            </div>

            <div className="grid grid-cols-7 flex-1 auto-rows-fr bg-gray-100 gap-px border-b border-gray-200">
              {calendarDays.map((day) => {
                const dateKey = format(day, 'yyyy-MM-dd');
                const log = logs[dateKey];
                const isCurrentMonth = isSameMonth(day, currentDate);
                const isDayToday = isToday(day);
                
                return (
                  <div 
                    key={dateKey}
                    onClick={() => onDateClick(day)}
                    className={`
                      relative bg-white min-h-[100px] p-2 transition-colors cursor-pointer hover:bg-gray-50 group
                      ${!isCurrentMonth ? 'bg-gray-50/30' : ''}
                    `}
                  >
                    <div className="flex justify-between items-start mb-1">
                      <span className={`text-sm font-medium w-7 h-7 flex items-center justify-center rounded-full ${isDayToday ? 'bg-indigo-600 text-white shadow-md' : !isCurrentMonth ? 'text-gray-300' : 'text-gray-700'}`}>
                        {format(day, 'd')}
                      </span>
                      {log && (
                        <div className={`w-4 h-4 rounded-full ${SCORE_COLORS[log.score]} shadow-sm ring-1 ring-white`} title="体調" />
                      )}
                    </div>
                    {log && (
                      <div className="mt-1">
                        <div className={`h-1.5 w-full rounded-full ${SCORE_COLORS[log.score]} md:hidden opacity-80`} />
                        <div className="hidden md:block">
                           <p className="text-xs text-gray-600 whitespace-pre-wrap break-words leading-snug">
                             {log.note}
                           </p>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            
            <div className="p-4 bg-white flex flex-wrap justify-center gap-4 text-xs text-gray-600 border-t border-gray-100">
              <div className="flex items-center gap-1.5"><span className="w-4 h-4 rounded-full bg-emerald-400"></span> 5 (最高)</div>
              <div className="flex items-center gap-1.5"><span className="w-4 h-4 rounded-full bg-teal-300"></span> 4</div>
              <div className="flex items-center gap-1.5"><span className="w-4 h-4 rounded-full bg-yellow-300"></span> 3</div>
              <div className="flex items-center gap-1.5"><span className="w-4 h-4 rounded-full bg-orange-300"></span> 2</div>
              <div className="flex items-center gap-1.5"><span className="w-4 h-4 rounded-full bg-rose-400"></span> 1 (最悪)</div>
            </div>
          </div>
        );
      };

      const StatsView = ({ logs }) => {
        const [period, setPeriod] = useState('30days');

        const chartData = useMemo(() => {
          const today = new Date();
          let daysToSubtract = 30;
          if (period === '7days') daysToSubtract = 7;
          if (period === '90days') daysToSubtract = 90;

          const startDate = subDays(today, daysToSubtract - 1);
          const interval = eachDayOfInterval({ start: startDate, end: today });

          return interval.map(date => {
            const dateKey = format(date, 'yyyy-MM-dd');
            const log = logs[dateKey];
            return {
              dateStr: dateKey,
              displayDate: format(date, 'M/d'),
              score: log ? log.score : null,
              mentalScore: log ? (log.mentalScore ?? log.score) : null,
              wheatIntake: log?.wheatIntake ? 1 : 0,
              wheatIntakeDisplay: log?.wheatIntake,
              note: log ? log.note : ''
            };
          });
        }, [logs, period]);

        const averages = useMemo(() => {
          const validLogs = chartData.filter(d => d.score !== null);
          if (validLogs.length === 0) return { physical: 0, mental: 0, wheatRate: 0 };
          
          const sumPhysical = validLogs.reduce((a, b) => a + b.score, 0);
          const sumMental = validLogs.reduce((a, b) => a + b.mentalScore, 0);
          const wheatCount = validLogs.filter(d => d.wheatIntakeDisplay).length;

          return {
            physical: (sumPhysical / validLogs.length).toFixed(1),
            mental: (sumMental / validLogs.length).toFixed(1),
            wheatRate: Math.round((wheatCount / validLogs.length) * 100)
          };
        }, [chartData]);

        const legendPayload = [
          { value: '体調', type: 'line', color: CHART_COLORS.physical, id: 'score' },
          { value: 'メンタル', type: 'line', color: CHART_COLORS.mental, id: 'mentalScore' },
          { value: '小麦摂取', type: 'rect', color: CHART_COLORS.wheat, id: 'wheatIntake' }
        ];

        const CustomTooltip = ({ active, payload, label }) => {
          if (active && payload && payload.length) {
            const data = payload[0].payload;
            return (
              <div className="bg-white p-3 border border-gray-100 shadow-lg rounded-xl text-sm z-50">
                <p className="font-bold text-gray-700 mb-2 border-b border-gray-100 pb-1">{data.displayDate}</p>
                <div className="space-y-1.5 mb-2">
                  <div className="flex items-center justify-between gap-4">
                    <span className="text-emerald-600 font-medium text-xs">体調</span>
                    <div className="flex items-center gap-1">
                      <span className={`w-2 h-2 rounded-full ${SCORE_COLORS[data.score] || 'bg-gray-300'}`}></span>
                      <span className="font-semibold">{data.score}</span>
                    </div>
                  </div>
                  <div className="flex items-center justify-between gap-4">
                     <span className="text-blue-600 font-medium text-xs">メンタル</span>
                     <div className="flex items-center gap-1">
                       <span className="font-semibold">{data.mentalScore}</span>
                     </div>
                  </div>
                  {data.wheatIntakeDisplay && (
                    <div className="flex items-center gap-1 text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full w-fit">
                      <Wheat size={10} />
                      <span className="text-[10px] font-medium">小麦摂取あり</span>
                    </div>
                  )}
                </div>
                {data.note && (
                   <p className="mt-2 pt-2 border-t border-gray-100 text-gray-500 text-xs italic max-w-[200px] truncate">
                     "{data.note}"
                   </p>
                )}
              </div>
            );
          }
          return null;
        };

        const ActivityIcon = () => (
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-500">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
        );

        return (
          <div className="flex flex-col h-full space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
              <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div><h2 className="text-xl font-bold text-gray-800">健康分析レポート</h2></div>
                <div className="flex bg-gray-100 p-1 rounded-lg">
                  {['7days', '30days', '90days'].map((p) => (
                    <button
                      key={p}
                      onClick={() => setPeriod(p)}
                      className={`px-4 py-1.5 text-xs font-medium rounded-md transition-all ${period === p ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      {p === '7days' ? '1週間' : p === '30days' ? '1ヶ月' : '3ヶ月'}
                    </button>
                  ))}
                </div>
              </div>

              <div className="flex gap-4 mb-4 text-sm flex-wrap">
                <div className="bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-100">
                  <span className="text-emerald-600/70 text-xs block">平均・体調</span>
                  <span className="text-emerald-700 font-bold text-lg">{averages.physical}</span>
                </div>
                <div className="bg-blue-50 px-3 py-2 rounded-lg border border-blue-100">
                  <span className="text-blue-600/70 text-xs block">平均・メンタル</span>
                  <span className="text-blue-700 font-bold text-lg">{averages.mental}</span>
                </div>
                <div className="bg-amber-50 px-3 py-2 rounded-lg border border-amber-100">
                  <span className="text-amber-600/70 text-xs block">小麦摂取率</span>
                  <span className="text-amber-700 font-bold text-lg">{averages.wheatRate}%</span>
                </div>
              </div>

              <div className="h-[350px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <ComposedChart data={chartData} margin={{ top: 10, right: 10, bottom: 5, left: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                    <XAxis dataKey="displayDate" tick={{ fontSize: 10, fill: '#94a3b8' }} axisLine={false} tickLine={false} interval={period === '90days' ? 6 : period === '30days' ? 2 : 0} />
                    <YAxis yAxisId="left" domain={[0, 6]} ticks={[1, 2, 3, 4, 5]} tick={{ fontSize: 10, fill: '#94a3b8' }} axisLine={false} tickLine={false} width={40} />
                    <YAxis yAxisId="right" hide domain={[0, 5]} />
                    <Tooltip content={<CustomTooltip />} cursor={{ stroke: '#cbd5e1', strokeWidth: 1, strokeDasharray: '4 4' }} />
                    <Legend wrapperStyle={{fontSize: '12px', paddingTop: '10px'}} payload={legendPayload} />
                    <ReferenceLine yAxisId="left" y={3} stroke="#e2e8f0" strokeDasharray="3 3" />
                    
                    <Bar yAxisId="right" dataKey="wheatIntake" name="小麦摂取" fill={CHART_COLORS.wheat} opacity={0.3} barSize={20} radius={[4, 4, 0, 0]} />
                    <Line yAxisId="left" type="monotone" dataKey="score" name="体調" stroke={CHART_COLORS.physical} strokeWidth={3} dot={{ r: 3, fill: CHART_COLORS.physical, strokeWidth: 2, stroke: '#fff' }} activeDot={{ r: 6, fill: CHART_COLORS.physical }} connectNulls animationDuration={1000} />
                    <Line yAxisId="left" type="monotone" dataKey="mentalScore" name="メンタル" stroke={CHART_COLORS.mental} strokeWidth={2} strokeDasharray="5 5" dot={{ r: 3, fill: CHART_COLORS.mental, strokeWidth: 2, stroke: '#fff' }} activeDot={{ r: 6, fill: CHART_COLORS.mental }} connectNulls animationDuration={1000} />
                  </ComposedChart>
                </ResponsiveContainer>
              </div>
            </div>
            
            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
              <h3 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                <ActivityIcon /> 分析インサイト
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                 <div className="bg-emerald-50 p-3 rounded-lg">
                   <span className="text-gray-500 block text-xs mb-1">小麦を摂取した日の平均体調</span>
                   {(() => {
                      const wheatDays = chartData.filter(d => d.wheatIntakeDisplay && d.score !== null);
                      const avg = wheatDays.length ? (wheatDays.reduce((a, b) => a + b.score, 0) / wheatDays.length).toFixed(1) : '-';
                      return <span className="font-bold text-emerald-700 text-lg">{avg}</span>;
                   })()}
                 </div>
                 <div className="bg-emerald-50 p-3 rounded-lg">
                   <span className="text-gray-500 block text-xs mb-1">摂取しなかった日の平均体調</span>
                   {(() => {
                      const noWheatDays = chartData.filter(d => !d.wheatIntakeDisplay && d.score !== null);
                      const avg = noWheatDays.length ? (noWheatDays.reduce((a, b) => a + b.score, 0) / noWheatDays.length).toFixed(1) : '-';
                      return <span className="font-bold text-emerald-700 text-lg">{avg}</span>;
                   })()}
                 </div>
              </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP ---

      const App = () => {
        const [currentView, setCurrentView] = useState('calendar');
        const [logs, setLogs] = useState({});
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [selectedDate, setSelectedDate] = useState(new Date());

        useEffect(() => {
          setLogs(getLogs());
          // Hide loading spinner
          const loader = document.getElementById('loading');
          if (loader) loader.style.display = 'none';
        }, []);

        const handleDateClick = (date) => {
          setSelectedDate(date);
          setIsModalOpen(true);
        };

        const handleSaveLog = (log) => {
          saveLog(log);
          setLogs(getLogs());
        };

        const handleDeleteLog = (dateStr) => {
          deleteLog(dateStr);
          setLogs(getLogs());
        };

        const selectedDateStr = format(selectedDate, 'yyyy-MM-dd');
        const currentLog = logs[selectedDateStr];

        return (
          <div className="min-h-screen bg-slate-50 text-gray-800 font-sans pb-24 md:pb-0">
            <header className="bg-white border-b border-gray-200 sticky top-0 z-10">
              <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="bg-indigo-600 p-2 rounded-lg text-white">
                    <Activity size={20} />
                  </div>
                  <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-indigo-400 bg-clip-text text-transparent">
                    HealthFlow
                  </h1>
                </div>
                <nav className="hidden md:flex bg-gray-100 p-1 rounded-lg">
                  <button onClick={() => setCurrentView('calendar')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${currentView === 'calendar' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                    <Calendar size={16} /> カレンダー
                  </button>
                  <button onClick={() => setCurrentView('stats')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${currentView === 'stats' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                    <BarChart2 size={16} /> 分析レポート
                  </button>
                </nav>
              </div>
            </header>

            <main className="max-w-4xl mx-auto p-4 md:p-6">
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                {currentView === 'calendar' ? (
                  <CalendarView logs={logs} onDateClick={handleDateClick} />
                ) : (
                  <StatsView logs={logs} />
                )}
              </div>
            </main>

            <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-around z-20 pb-safe">
              <button onClick={() => setCurrentView('calendar')} className={`flex flex-col items-center gap-1 ${currentView === 'calendar' ? 'text-indigo-600' : 'text-gray-400'}`}>
                <Calendar size={24} strokeWidth={currentView === 'calendar' ? 2.5 : 2} />
                <span className="text-[10px] font-medium">カレンダー</span>
              </button>
              <button onClick={() => setCurrentView('stats')} className={`flex flex-col items-center gap-1 ${currentView === 'stats' ? 'text-indigo-600' : 'text-gray-400'}`}>
                <BarChart2 size={24} strokeWidth={currentView === 'stats' ? 2.5 : 2} />
                <span className="text-[10px] font-medium">分析</span>
              </button>
            </div>

            <LogModal
              isOpen={isModalOpen}
              onClose={() => setIsModalOpen(false)}
              date={selectedDate}
              existingLog={currentLog}
              onSave={handleSaveLog}
              onDelete={handleDeleteLog}
            />
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
